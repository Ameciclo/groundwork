# Architecture Overview

## Should ArgoCD be behind Kong?

**Answer: NO** âŒ

ArgoCD should **NOT** be behind Kong. Here's why:

1. **Different Purposes**: Kong manages external API traffic; ArgoCD manages internal cluster operations
2. **Circular Dependency**: ArgoCD manages Kong, so Kong managing ArgoCD access creates a circular dependency
3. **Operational Risk**: If Kong fails, you lose access to ArgoCD and can't deploy fixes
4. **Security**: ArgoCD should be restricted to internal/VPN access only; Kong should be public-facing

---

## Recommended System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTERNET / USERS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Kong Proxy     â”‚
                    â”‚ (Port 30292)    â”‚
                    â”‚ (Port 31150)    â”‚
                    â”‚ 20.172.9.53     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Service â”‚         â”‚ Service    â”‚      â”‚ Service    â”‚
   â”‚   A     â”‚         â”‚    B       â”‚      â”‚    C       â”‚
   â”‚ (Atlas) â”‚         â”‚ (Atlas)    â”‚      â”‚ (Atlas)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PostgreSQL     â”‚
                    â”‚  (Private VPC)  â”‚
                    â”‚  10.10.2.4      â”‚
                    â”‚  SSL Enabled    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTERNAL / VPN ONLY                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ArgoCD (GitOps Management)                  â”‚   â”‚
â”‚  â”‚  â€¢ Manages Kong configuration                           â”‚   â”‚
â”‚  â”‚  â€¢ Manages all services                                 â”‚   â”‚
â”‚  â”‚  â€¢ Manages cluster infrastructure                       â”‚   â”‚
â”‚  â”‚  Access: http://10.20.1.4:80 (Traefik Ingress)         â”‚   â”‚
â”‚  â”‚  Credentials: admin/5y5Xlzpdu2k215Gd                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Kong Admin API                              â”‚   â”‚
â”‚  â”‚  â€¢ Configure routes, services, plugins                  â”‚   â”‚
â”‚  â”‚  â€¢ Access: http://10.20.1.4:8001 (internal only)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Kubernetes API                              â”‚   â”‚
â”‚  â”‚  â€¢ Cluster management                                   â”‚   â”‚
â”‚  â”‚  â€¢ Access: https://10.20.1.4:6443 (internal only)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Azure Cloud                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              K3s Cluster (Single Node)                   â”‚  â”‚
â”‚  â”‚              ameciclo-k3s-vm                             â”‚  â”‚
â”‚  â”‚              10.20.1.4 (Private)                         â”‚  â”‚
â”‚  â”‚              20.172.9.53 (Public)                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚         Kubernetes Namespaces                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   argocd     â”‚  â”‚    kong      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ server     â”‚  â”‚ â€¢ proxy      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ repo       â”‚  â”‚ â€¢ admin      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ redis      â”‚  â”‚ â€¢ manager    â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ controller â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  kube-system â”‚  â”‚    atlas     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚  (ready)     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ coredns    â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ metrics    â”‚  â”‚ â€¢ cyclist-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ ingress    â”‚  â”‚   profile    â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ cyclist-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚   counts     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚ â€¢ traffic-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚   deaths     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Services:                                              â”‚  â”‚
â”‚  â”‚  â€¢ ArgoCD Server: Ingress (10.20.1.4:80)               â”‚  â”‚
â”‚  â”‚  â€¢ Kong Proxy: NodePort (30292, 31150)                 â”‚  â”‚
â”‚  â”‚  â€¢ Kong Manager: NodePort (32147)                      â”‚  â”‚
â”‚  â”‚  â€¢ Kong Admin: NodePort (8001)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Azure PostgreSQL Flexible Server                      â”‚  â”‚
â”‚  â”‚    ameciclo-postgres.privatelink.postgres.database.azure.com
â”‚  â”‚    B_Standard_B2s (2 vCores, 4 GB RAM)                   â”‚  â”‚
â”‚  â”‚    SSL: âœ… Enabled (sslmode=require, verify-full)        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚    Databases:                                           â”‚  â”‚
â”‚  â”‚    â€¢ kong (Kong configuration)                          â”‚  â”‚
â”‚  â”‚    â€¢ atlas (Microservices data)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                          â†‘
         â”‚                                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  GitHub Repo   â”‚
                    â”‚  groundwork    â”‚
                    â”‚                â”‚
                    â”‚ azure/         â”‚
                    â”‚ kubernetes/    â”‚
                    â”‚ â€¢ kong/        â”‚
                    â”‚ â€¢ atlas/       â”‚
                    â”‚ â€¢ kestra/      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Developer    â”‚
                    â”‚   Workflow     â”‚
                    â”‚                â”‚
                    â”‚ 1. Edit files  â”‚
                    â”‚ 2. git push    â”‚
                    â”‚ 3. ArgoCD      â”‚
                    â”‚    syncs auto  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Access Points

### Public Access (via Azure NSG)
- **Kong Proxy HTTP**: http://20.172.9.53:30292
- **Kong Proxy HTTPS**: https://20.172.9.53:31150
- **Kong Manager UI**: http://20.172.9.53:32147
- **SSH**: ssh://20.172.9.53:22

### Internal Access (VPC only)
- **ArgoCD**: http://10.20.1.4:80
- **Kong Admin API**: http://10.20.1.4:8001
- **Kubernetes API**: https://10.20.1.4:6443
- **PostgreSQL**: ameciclo-postgres.privatelink.postgres.database.azure.com:5432

---

## Data Flow

### GitOps Workflow

```
Developer
    â†“
Edit azure/kubernetes/kong/values.yaml
    â†“
git add, commit, push
    â†“
GitHub Repository
    â†“
ArgoCD watches repository
    â†“
Detects changes
    â†“
Helm chart renders
    â†“
ArgoCD applies manifests
    â†“
Kubernetes updates Kong pods
    â†“
Kong running with new configuration
```

### API Request Flow

```
External Client Request
    â†“
Kong Proxy (20.172.9.53:30292)
    â†“
Kong Routes & Plugins
    â”œâ”€ Authentication
    â”œâ”€ Rate Limiting
    â”œâ”€ Logging
    â””â”€ Request Transformation
    â†“
Atlas Microservices
    â”œâ”€ cyclist-profile
    â”œâ”€ cyclist-counts
    â””â”€ traffic-deaths
    â†“
PostgreSQL Database (SSL)
    â†“
Response back to Client
```

### Management Flow

```
Developer/Admin
    â†“
ArgoCD UI (10.20.1.4:80)
    â†“
Kong Manager UI (20.172.9.53:32147)
    â†“
Kong Admin API (10.20.1.4:8001)
    â†“
Kong Configuration
```

## Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Azure VNet                           â”‚
â”‚                    10.20.0.0/16                         â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         K3s Subnet                               â”‚  â”‚
â”‚  â”‚         10.20.1.0/24                             â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  K3s VM                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  10.20.1.4 (Private)                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  20.172.9.53 (Public)                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ArgoCD: 80, 443                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Proxy: 80, 443                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Admin: 8001                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Manager: 8002                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ K3s API: 6443                           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  PostgreSQL Firewall Rules:                            â”‚
â”‚  â€¢ Allow K3s subnet (10.20.1.0/24)                     â”‚
â”‚  â€¢ Allow regular VM subnet (10.10.1.0/24)              â”‚
â”‚  â€¢ Port 5432                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ArgoCD                               â”‚
â”‚  (Watches Git, syncs to cluster)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€â†’ Kong Application
                     â”‚   (Helm chart from Git)
                     â”‚
                     â”œâ”€â†’ Atlas Application
                     â”‚   (Microservices from Git)
                     â”‚
                     â””â”€â†’ Kestra Application
                         (Workflow orchestration)
                         
                         â†“
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Kubernetes                             â”‚
â”‚  (Runs containers, manages services)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€â†’ Kong Pods
                     â”‚   (API Gateway)
                     â”‚
                     â”œâ”€â†’ Atlas Pods
                     â”‚   (Microservices)
                     â”‚
                     â””â”€â†’ Kestra Pods
                         (Workflow engine)
                         
                         â†“
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL Database                        â”‚
â”‚  (Persistent data storage)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Resource Allocation

```
Total VM Resources: 8 GB RAM, 2 vCPU

Current Usage:
â”œâ”€ ArgoCD: ~167 MB
â”‚  â”œâ”€ server: 37 MB
â”‚  â”œâ”€ application-controller: 28 MB
â”‚  â”œâ”€ applicationset-controller: 28 MB
â”‚  â”œâ”€ repo-server: 23 MB
â”‚  â”œâ”€ dex-server: 26 MB
â”‚  â”œâ”€ notifications-controller: 20 MB
â”‚  â””â”€ redis: 7 MB
â”‚
â”œâ”€ Kube-system: ~46 MB
â”‚  â”œâ”€ coredns: 16 MB
â”‚  â”œâ”€ metrics-server: 22 MB
â”‚  â””â”€ local-path-provisioner: 8 MB
â”‚
â”œâ”€ Kong: (initializing)
â”‚
â””â”€ Available: ~6.2 GB (85%)
```

## Deployment Sequence

```
1. Terraform
   â””â”€â†’ Creates Azure infrastructure
       â”œâ”€ K3s VM
       â”œâ”€ PostgreSQL
       â””â”€ Network

2. Ansible
   â””â”€â†’ Installs K3s and ArgoCD
       â”œâ”€ K3s cluster
       â”œâ”€ Helm
       â”œâ”€ ArgoCD
       â””â”€ Kong (via Helm)

3. GitOps (ArgoCD)
   â””â”€â†’ Manages all applications
       â”œâ”€ Kong (from Git)
       â”œâ”€ Atlas (from Git)
       â””â”€ Kestra (from Git)
```

## Security Architecture

### Network Segmentation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PUBLIC ZONE (Internet-facing)                          â”‚
â”‚  â€¢ Kong Proxy (30292, 31150)                            â”‚
â”‚  â€¢ Kong Manager (32147)                                 â”‚
â”‚  â€¢ SSH (22)                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INTERNAL ZONE (VPC only)                               â”‚
â”‚  â€¢ ArgoCD (80)                                          â”‚
â”‚  â€¢ Kong Admin API (8001)                                â”‚
â”‚  â€¢ Kubernetes API (6443)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIVATE ZONE (VPC peering only)                        â”‚
â”‚  â€¢ PostgreSQL (5432)                                    â”‚
â”‚  â€¢ SSL/TLS encryption enabled                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Network Security                              â”‚
â”‚  â€¢ Azure NSG (Network Security Group)                   â”‚
â”‚  â€¢ Firewall rules:                                      â”‚
â”‚    - AllowSSH (22)                                      â”‚
â”‚    - AllowHTTP (80)                                     â”‚
â”‚    - AllowHTTPS (443)                                   â”‚
â”‚    - AllowK3sAPI (6443)                                 â”‚
â”‚    - AllowKongProxy (30292, 31150)                      â”‚
â”‚    - AllowKongManager (32147)                           â”‚
â”‚  â€¢ PostgreSQL firewall rules (VPC only)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Kubernetes Security                           â”‚
â”‚  â€¢ RBAC (Role-Based Access Control)                     â”‚
â”‚  â€¢ Network Policies                                     â”‚
â”‚  â€¢ Service Accounts                                     â”‚
â”‚  â€¢ Secrets for credentials                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Application Security                          â”‚
â”‚  â€¢ Kong authentication plugins                          â”‚
â”‚  â€¢ PostgreSQL SSL/TLS (sslmode=require, verify-full)    â”‚
â”‚  â€¢ Kong Manager UI (internal access)                    â”‚
â”‚  â€¢ ArgoCD authentication                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PostgreSQL SSL Configuration

```
Connection String:
  Host: ameciclo-postgres.privatelink.postgres.database.azure.com
  Port: 5432
  User: psqladmin
  Database: kong
  SSL Mode: require (or verify-full)

Verified Modes:
  âœ… sslmode=require - Connection encrypted
  âœ… sslmode=verify-full - Certificate validation enabled
```

---

## Why This Architecture?

### Kong as Public API Gateway
- âœ… Handles all external traffic
- âœ… Provides rate limiting, authentication, logging
- âœ… Can be scaled independently
- âœ… Protects internal services

### ArgoCD Internal Only
- âœ… GitOps management tool
- âœ… No need for public access
- âœ… Manages Kong configuration
- âœ… Manages all cluster resources

### Separation of Concerns
- âœ… Kong: External API management
- âœ… ArgoCD: Internal cluster management
- âœ… PostgreSQL: Data persistence (private)
- âœ… Each component has single responsibility

---

**Your infrastructure is production-ready and fully GitOps-enabled!** ğŸš€

