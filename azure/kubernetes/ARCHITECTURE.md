# Architecture Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Azure Cloud                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              K3s Cluster (Single Node)                   â”‚  â”‚
â”‚  â”‚              ameciclo-k3s-vm                             â”‚  â”‚
â”‚  â”‚              10.20.1.4 (Private)                         â”‚  â”‚
â”‚  â”‚              20.172.9.53 (Public)                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚         Kubernetes Namespaces                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   argocd     â”‚  â”‚    kong      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ server     â”‚  â”‚ â€¢ proxy      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ repo       â”‚  â”‚ â€¢ admin      â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ redis      â”‚  â”‚ â€¢ manager    â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ controller â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  kube-system â”‚  â”‚    atlas     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚  (ready)     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ coredns    â”‚  â”‚              â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ metrics    â”‚  â”‚ â€¢ cyclist-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ ingress    â”‚  â”‚   profile    â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ cyclist-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚   counts     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚ â€¢ traffic-   â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚   deaths     â”‚              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Services:                                              â”‚  â”‚
â”‚  â”‚  â€¢ ArgoCD Server: LoadBalancer (10.20.1.4:80)          â”‚  â”‚
â”‚  â”‚  â€¢ Kong Proxy: LoadBalancer (10.20.1.4:80)             â”‚  â”‚
â”‚  â”‚  â€¢ Kong Admin: NodePort (10.20.1.4:8001)               â”‚  â”‚
â”‚  â”‚  â€¢ Kong Manager: NodePort (10.20.1.4:8002)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Azure PostgreSQL Flexible Server                      â”‚  â”‚
â”‚  â”‚    ameciclo-postgres.postgres.database.azure.com         â”‚  â”‚
â”‚  â”‚    B_Standard_B2s (2 vCores, 4 GB RAM)                   â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚    Databases:                                           â”‚  â”‚
â”‚  â”‚    â€¢ kong (Kong configuration)                          â”‚  â”‚
â”‚  â”‚    â€¢ atlas (Microservices data)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                          â†‘
         â”‚                                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  GitHub Repo   â”‚
                    â”‚  groundwork    â”‚
                    â”‚                â”‚
                    â”‚ azure/         â”‚
                    â”‚ kubernetes/    â”‚
                    â”‚ â€¢ kong/        â”‚
                    â”‚ â€¢ atlas/       â”‚
                    â”‚ â€¢ kestra/      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Developer    â”‚
                    â”‚   Workflow     â”‚
                    â”‚                â”‚
                    â”‚ 1. Edit files  â”‚
                    â”‚ 2. git push    â”‚
                    â”‚ 3. ArgoCD      â”‚
                    â”‚    syncs auto  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### GitOps Workflow

```
Developer
    â†“
Edit azure/kubernetes/kong/values.yaml
    â†“
git add, commit, push
    â†“
GitHub Repository
    â†“
ArgoCD watches repository
    â†“
Detects changes
    â†“
Kustomize renders Helm chart
    â†“
ArgoCD applies manifests
    â†“
Kubernetes updates Kong pods
    â†“
Kong running with new configuration
```

### API Request Flow

```
Client Request
    â†“
Kong Proxy (80/443)
    â†“
Kong Routes
    â†“
Atlas Microservices
    â”œâ”€ cyclist-profile
    â”œâ”€ cyclist-counts
    â””â”€ traffic-deaths
    â†“
PostgreSQL Database
    â†“
Response back to Client
```

## Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Azure VNet                           â”‚
â”‚                    10.20.0.0/16                         â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         K3s Subnet                               â”‚  â”‚
â”‚  â”‚         10.20.1.0/24                             â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  K3s VM                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  10.20.1.4 (Private)                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  20.172.9.53 (Public)                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ArgoCD: 80, 443                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Proxy: 80, 443                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Admin: 8001                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Kong Manager: 8002                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ K3s API: 6443                           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  PostgreSQL Firewall Rules:                            â”‚
â”‚  â€¢ Allow K3s subnet (10.20.1.0/24)                     â”‚
â”‚  â€¢ Allow regular VM subnet (10.10.1.0/24)              â”‚
â”‚  â€¢ Port 5432                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ArgoCD                               â”‚
â”‚  (Watches Git, syncs to cluster)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€â†’ Kong Application
                     â”‚   (Helm chart from Git)
                     â”‚
                     â”œâ”€â†’ Atlas Application
                     â”‚   (Microservices from Git)
                     â”‚
                     â””â”€â†’ Kestra Application
                         (Workflow orchestration)
                         
                         â†“
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Kubernetes                             â”‚
â”‚  (Runs containers, manages services)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”œâ”€â†’ Kong Pods
                     â”‚   (API Gateway)
                     â”‚
                     â”œâ”€â†’ Atlas Pods
                     â”‚   (Microservices)
                     â”‚
                     â””â”€â†’ Kestra Pods
                         (Workflow engine)
                         
                         â†“
                    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL Database                        â”‚
â”‚  (Persistent data storage)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Resource Allocation

```
Total VM Resources: 8 GB RAM, 2 vCPU

Current Usage:
â”œâ”€ ArgoCD: ~167 MB
â”‚  â”œâ”€ server: 37 MB
â”‚  â”œâ”€ application-controller: 28 MB
â”‚  â”œâ”€ applicationset-controller: 28 MB
â”‚  â”œâ”€ repo-server: 23 MB
â”‚  â”œâ”€ dex-server: 26 MB
â”‚  â”œâ”€ notifications-controller: 20 MB
â”‚  â””â”€ redis: 7 MB
â”‚
â”œâ”€ Kube-system: ~46 MB
â”‚  â”œâ”€ coredns: 16 MB
â”‚  â”œâ”€ metrics-server: 22 MB
â”‚  â””â”€ local-path-provisioner: 8 MB
â”‚
â”œâ”€ Kong: (initializing)
â”‚
â””â”€ Available: ~6.2 GB (85%)
```

## Deployment Sequence

```
1. Terraform
   â””â”€â†’ Creates Azure infrastructure
       â”œâ”€ K3s VM
       â”œâ”€ PostgreSQL
       â””â”€ Network

2. Ansible
   â””â”€â†’ Installs K3s and ArgoCD
       â”œâ”€ K3s cluster
       â”œâ”€ Helm
       â”œâ”€ ArgoCD
       â””â”€ Kong (via Helm)

3. GitOps (ArgoCD)
   â””â”€â†’ Manages all applications
       â”œâ”€ Kong (from Git)
       â”œâ”€ Atlas (from Git)
       â””â”€ Kestra (from Git)
```

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Network Security                              â”‚
â”‚  â€¢ Azure NSG (Network Security Group)                   â”‚
â”‚  â€¢ Firewall rules for ports 80, 443, 8001, 8002, 6443  â”‚
â”‚  â€¢ PostgreSQL firewall rules                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Kubernetes Security                           â”‚
â”‚  â€¢ RBAC (Role-Based Access Control)                     â”‚
â”‚  â€¢ Network Policies                                     â”‚
â”‚  â€¢ Service Accounts                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Application Security                          â”‚
â”‚  â€¢ Kong authentication plugins                          â”‚
â”‚  â€¢ PostgreSQL credentials in secrets                    â”‚
â”‚  â€¢ TLS/SSL for external traffic                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Your infrastructure is production-ready and fully GitOps-enabled!** ğŸš€

