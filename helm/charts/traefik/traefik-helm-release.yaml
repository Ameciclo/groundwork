# Traefik Helm Release
# Deploys Traefik using the official Helm chart
# This replaces K3s's built-in Traefik with a managed version

apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: traefik
  namespace: kube-system
spec:
  repo: https://traefik.github.io/charts
  chart: traefik
  version: 37.2.0
  targetNamespace: kube-system
  set:
    # Global settings
    global.checkNewVersion: "false"
    global.sendAnonymousUsage: "false"

    # Service configuration
    service.type: LoadBalancer

    # Dashboard and API
    api.dashboard: "true"
    ingressClass.enabled: "true"
    ingressClass.isDefaultClass: "true"

    # Entry points
    ports.web.port: 8000
    ports.websecure.port: 8443
    ports.traefik.port: 8080
    ports.traefik.expose.default: "true"
    ports.metrics.port: 9100

    # Providers (camelCase for v37+)
    providers.kubernetesCRD.enabled: "true"
    providers.kubernetesIngress.enabled: "true"

    # ACME / Let's Encrypt Certificate Provider
    certificatesResolvers.letsencrypt.acme.email: "admin@ameciclo.org"
    certificatesResolvers.letsencrypt.acme.storage: "/data/acme.json"
    certificatesResolvers.letsencrypt.acme.httpChallenge.entryPoint: "web"

    # Metrics
    metrics.prometheus.enabled: "true"
    metrics.prometheus.entryPoint: metrics

    # Logging
    logs.general.level: INFO
    logs.general.format: json
    logs.access.enabled: "true"
    logs.access.format: json
