# Zitadel Helm Release
# Deploys Zitadel using the official Helm chart
# Identity and Access Management Solution

apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: zitadel
  namespace: zitadel
spec:
  repo: https://charts.zitadel.com
  chart: zitadel
  version: 8.5.1  # Use v8 which includes Zitadel v2.x with built-in login UI
  targetNamespace: zitadel
  valuesContent: |-
    # Zitadel configuration
    zitadel:
      # Master key for encryption
      # IMPORTANT: Change this in production and store securely
      masterkeySecretName: zitadel-masterkey

      # Configure external domain
      configmapConfig:
        ExternalDomain: zitadel.armadillo-hamal.ts.net
        ExternalPort: 443
        ExternalSecure: true
        TLS:
          Enabled: false  # TLS is handled by Tailscale/Traefik

        # Database configuration using connection string
        Database:
          Postgres:
            Host: ameciclo-postgres.postgres.database.azure.com
            Port: 5432
            Database: zitadel
            MaxOpenConns: 25
            MaxIdleConns: 10
            MaxConnLifetime: 1h
            MaxConnIdleTime: 5m
            User:
              Username: psqladmin
              SSL:
                Mode: require
            Admin:
              Username: psqladmin
              SSL:
                Mode: require

      # Database credentials from secrets
      dbSslCaCrtSecret: ""
      dbSslAdminCrtSecret: ""
      dbSslUserCrtSecret: ""
    
    # Replica configuration
    replicaCount: 2
    
    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    # Service configuration
    service:
      type: ClusterIP
      port: 8080
      protocol: http2
      annotations:
        traefik.ingress.kubernetes.io/service.serversscheme: h2c
    
    # Ingress disabled - using separate Tailscale ingress
    ingress:
      enabled: false
    
    # Login v2 not available in chart v8
    
    # Init job configuration
    initJob:
      activeDeadlineSeconds: 600
      env:
        - name: ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-db-password
              key: DATABASE_PASSWORD
        - name: ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-db-password
              key: DATABASE_PASSWORD

    # Setup job configuration
    setupJob:
      activeDeadlineSeconds: 1200
      env:
        - name: ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-db-password
              key: DATABASE_PASSWORD
        - name: ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zitadel-db-password
              key: DATABASE_PASSWORD
      annotations:
        helm.sh/hook-delete-policy: before-hook-creation

    # Load environment variables from secret
    envVarsSecret: zitadel-db-password

