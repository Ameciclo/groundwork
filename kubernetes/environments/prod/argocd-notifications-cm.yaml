apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications
    app.kubernetes.io/part-of: argocd
data:
  # Telegram service configuration
  service.telegram: |
    token: $TELEGRAM_BOT_TOKEN
    chatID: $TELEGRAM_CHAT_ID

  # Enhanced notification templates
  template.app-deployed: |
    message: |
      ğŸš€ **Deployment Successful** 
      
      ğŸ“¦ **Application:** `{{.app.metadata.name}}`
      ğŸ·ï¸ **Environment:** `{{.app.metadata.namespace}}`
      âœ… **Status:** {{.app.status.sync.status}}
      ğŸ”„ **Health:** {{.app.status.health.status}}
      
      ğŸ“‹ **Sync Details:**
      â€¢ **Operation ID:** `{{.app.status.operationState.operation.sync.syncId}}`
      â€¢ **Revision:** `{{.app.status.sync.revision | substr 0 8}}`
      â€¢ **Started:** {{.app.status.operationState.startedAt}}
      â€¢ **Finished:** {{.app.status.operationState.finishedAt}}
      
      ğŸ”— **Repository:** [{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}]({{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}})
      ğŸ“ **Path:** `{{.app.spec.source.path}}`
      ğŸŒ¿ **Branch:** `{{.app.spec.source.targetRevision}}`
      
      {{if .app.status.operationState.syncResult.resources}}
      ğŸ“Š **Resources Synced:**
      {{range .app.status.operationState.syncResult.resources}}
      â€¢ {{.kind}}/{{.name}} - {{.status}}
      {{end}}
      {{end}}
      
      ğŸ¯ **ArgoCD:** [View Application](https://argocd.armadillo-hamal.ts.net/applications/{{.app.metadata.name}})

  template.app-sync-failed: |
    message: |
      âŒ **Deployment Failed**
      
      ğŸ“¦ **Application:** `{{.app.metadata.name}}`
      ğŸ·ï¸ **Environment:** `{{.app.metadata.namespace}}`
      âš ï¸ **Status:** {{.app.status.sync.status}}
      ğŸ”´ **Health:** {{.app.status.health.status}}
      
      ğŸ’¥ **Error Details:**
      ```
      {{.app.status.operationState.message}}
      ```
      
      ğŸ“‹ **Sync Details:**
      â€¢ **Operation ID:** `{{.app.status.operationState.operation.sync.syncId}}`
      â€¢ **Revision:** `{{.app.status.sync.revision | substr 0 8}}`
      â€¢ **Started:** {{.app.status.operationState.startedAt}}
      â€¢ **Failed:** {{.app.status.operationState.finishedAt}}
      
      ğŸ”— **Repository:** [{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}]({{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}})
      ğŸ“ **Path:** `{{.app.spec.source.path}}`
      ğŸŒ¿ **Branch:** `{{.app.spec.source.targetRevision}}`
      
      ğŸ¯ **ArgoCD:** [View Application](https://argocd.armadillo-hamal.ts.net/applications/{{.app.metadata.name}})
      
      ğŸ”§ **Next Steps:**
      â€¢ Check application logs
      â€¢ Review resource configurations
      â€¢ Verify dependencies

  template.app-health-degraded: |
    message: |
      ğŸŸ¡ **Application Health Degraded**
      
      ğŸ“¦ **Application:** `{{.app.metadata.name}}`
      ğŸ·ï¸ **Environment:** `{{.app.metadata.namespace}}`
      âš ï¸ **Health Status:** {{.app.status.health.status}}
      ğŸ”„ **Sync Status:** {{.app.status.sync.status}}
      
      ğŸ©º **Health Details:**
      {{if .app.status.health.message}}
      ```
      {{.app.status.health.message}}
      ```
      {{end}}
      
      ğŸ“Š **Resource Status:**
      {{range .app.status.resources}}
      {{if ne .health.status "Healthy"}}
      â€¢ {{.kind}}/{{.name}} - {{.health.status}}
      {{end}}
      {{end}}
      
      ğŸ”— **Repository:** [{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}]({{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}})
      ğŸ“ **Path:** `{{.app.spec.source.path}}`
      
      ğŸ¯ **ArgoCD:** [View Application](https://argocd.armadillo-hamal.ts.net/applications/{{.app.metadata.name}})
      
      ğŸ”§ **Action Required:**
      â€¢ Check pod logs and events
      â€¢ Verify resource health
      â€¢ Monitor for recovery

  # Notification triggers
  trigger.on-deployed: |
    - description: Application is synced and healthy
      send:
      - app-deployed
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  trigger.on-sync-failed: |
    - description: Application syncing has failed
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']

  trigger.on-health-degraded: |
    - description: Application has degraded
      send:
      - app-health-degraded
      when: app.status.health.status == 'Degraded'

  # Additional notification templates
  template.app-sync-running: |
    message: |
      ğŸ”„ **Deployment In Progress**

      ğŸ“¦ **Application:** `{{.app.metadata.name}}`
      ğŸ·ï¸ **Environment:** `{{.app.metadata.namespace}}`
      â³ **Status:** Syncing...

      ğŸ“‹ **Sync Details:**
      â€¢ **Operation ID:** `{{.app.status.operationState.operation.sync.syncId}}`
      â€¢ **Revision:** `{{.app.status.sync.revision | substr 0 8}}`
      â€¢ **Started:** {{.app.status.operationState.startedAt}}

      ğŸ”— **Repository:** [{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}]({{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}})
      ğŸ“ **Path:** `{{.app.spec.source.path}}`
      ğŸŒ¿ **Branch:** `{{.app.spec.source.targetRevision}}`

      ğŸ¯ **ArgoCD:** [View Application](https://argocd.armadillo-hamal.ts.net/applications/{{.app.metadata.name}})

  template.app-sync-status-unknown: |
    message: |
      â“ **Application Status Unknown**

      ğŸ“¦ **Application:** `{{.app.metadata.name}}`
      ğŸ·ï¸ **Environment:** `{{.app.metadata.namespace}}`
      â“ **Status:** {{.app.status.sync.status}}
      ğŸ” **Health:** {{.app.status.health.status}}

      ğŸ“‹ **Details:**
      â€¢ **Revision:** `{{.app.status.sync.revision | substr 0 8}}`
      â€¢ **Last Sync:** {{.app.status.operationState.finishedAt}}

      ğŸ”— **Repository:** [{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}]({{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}})
      ğŸ“ **Path:** `{{.app.spec.source.path}}`

      ğŸ¯ **ArgoCD:** [View Application](https://argocd.armadillo-hamal.ts.net/applications/{{.app.metadata.name}})

      ğŸ”§ **Action Required:**
      â€¢ Check ArgoCD controller logs
      â€¢ Verify cluster connectivity
      â€¢ Review application configuration

  # Additional triggers
  trigger.on-sync-running: |
    - description: Application is being synced
      send:
      - app-sync-running
      when: app.status.operationState.phase in ['Running']

  trigger.on-sync-status-unknown: |
    - description: Application status is unknown
      send:
      - app-sync-status-unknown
      when: app.status.sync.status == 'Unknown'

  # Subscription configuration
  subscriptions: |
    - recipients:
      - telegram
      triggers:
      - on-deployed
      - on-sync-failed
      - on-health-degraded
      - on-sync-running
      - on-sync-status-unknown
