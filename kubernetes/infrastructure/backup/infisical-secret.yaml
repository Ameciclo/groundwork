# InfisicalSecret to sync backup credentials from Infisical
#
# Required secrets in Infisical (project: backup):
#
#   PostgreSQL connection:
#   - PGHOST: ameciclo-postgres.privatelink.postgres.database.azure.com
#   - PGUSER: psqladmin
#   - PGPASSWORD: (from Pulumi: pulumi stack output postgresqlAdminPassword --show-secrets)
#
#   Azure Blob Storage:
#   - AZURE_STORAGE_ACCOUNT: ameciclostor... (from Pulumi: pulumi stack output storageAccountName)
#   - AZURE_STORAGE_KEY: (from Azure Portal or CLI)
#   - AZURE_CONTAINER: backups
#
# To get the storage key:
#   az storage account keys list --account-name <storage-account-name> --query '[0].value' -o tsv
#
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: backup-infisical-secret
  namespace: backup
  labels:
    app.kubernetes.io/name: backup
    app.kubernetes.io/part-of: infrastructure
spec:
  hostAPI: https://app.infisical.com/api
  resyncInterval: 300  # 5 minutes
  authentication:
    universalAuth:
      secretsScope:
        projectSlug: backup
        envSlug: prod
        secretsPath: "/"
      credentialsRef:
        secretName: infisical-auth
        secretNamespace: infisical-system
  managedSecretReference:
    secretName: backup-secrets
    secretNamespace: backup
    secretType: Opaque
    creationPolicy: Owner

