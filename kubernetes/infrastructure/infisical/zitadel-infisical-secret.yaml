---
# InfisicalSecret CRD to sync Zitadel secrets from Infisical to Kubernetes
# Uses Universal Auth with credentials from central infisical-system namespace
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: zitadel-secrets
  namespace: zitadel
  labels:
    app.kubernetes.io/name: zitadel
    app.kubernetes.io/part-of: zitadel
    app.kubernetes.io/component: secrets
spec:
  # Infisical API endpoint
  hostAPI: https://app.infisical.com/api

  # Universal Auth authentication
  # Credentials stored in central infisical-system namespace
  authentication:
    universalAuth:
      secretsScope:
        projectSlug: zitadel  # TODO: Update with actual Infisical project slug
        envSlug: prod
        secretsPath: "/"
      credentialsRef:
        secretName: infisical-universal-auth
        secretNamespace: infisical-system  # Central namespace for all apps

  # Target Kubernetes secret
  managedSecretReference:
    secretName: zitadel-infisical-managed
    secretNamespace: zitadel
    creationPolicy: Owner

  # Sync interval in seconds
  resyncInterval: 60

# =============================================================
# REQUIRED SECRETS IN INFISICAL
# =============================================================
# Create these secrets in your Infisical project (zitadel):
#
# DATABASE_HOST          - Azure PostgreSQL hostname
#                          e.g., ameciclo-postgres.postgres.database.azure.com
#
# DATABASE_USER          - Database username for Zitadel runtime
#                          e.g., zitadel@ameciclo-postgres
#
# DATABASE_PASSWORD      - Database password for runtime user
#
# DATABASE_ADMIN_USER    - Database admin username (for migrations)
#                          e.g., zitadel_admin@ameciclo-postgres
#
# DATABASE_ADMIN_PASSWORD - Database admin password
#
# masterkey              - 32-byte base64 encoded master key for encryption
#                          Generate with: openssl rand -base64 32
#
# =============================================================
# DATABASE SETUP (Run on Azure PostgreSQL)
# =============================================================
# -- Create database
# CREATE DATABASE zitadel;
#
# -- Create admin user (for migrations)
# CREATE USER zitadel_admin WITH PASSWORD 'your-admin-password';
# GRANT ALL PRIVILEGES ON DATABASE zitadel TO zitadel_admin;
# ALTER USER zitadel_admin CREATEDB;
#
# -- Create runtime user
# CREATE USER zitadel WITH PASSWORD 'your-runtime-password';
# GRANT CONNECT ON DATABASE zitadel TO zitadel;
#
# -- After Zitadel creates tables, grant permissions:
# GRANT USAGE ON SCHEMA public TO zitadel;
# GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO zitadel;
# GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO zitadel;

